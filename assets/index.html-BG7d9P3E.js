import{_ as a,e as i,f as n,o as e}from"./app-Cx_oisp2.js";const p="/assets/image-20250827211626905-C8MQQ1MK.png",l="/assets/image-20250827224341750-fvDucL9x.png",t={};function h(c,s){return e(),i("div",null,s[0]||(s[0]=[n(`<h2 id="redis保持原子性操作方式" tabindex="-1"><a class="header-anchor" href="#redis保持原子性操作方式"><span>Redis保持原子性操作方式</span></a></h2><h3 id="事务" tabindex="-1"><a class="header-anchor" href="#事务"><span>事务</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">开启事务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">multi</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">命令1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">set</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">10</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">命令2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incr</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">命令3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">执行（提交事务）</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">exec</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redis的事务和mysql的事务不一样，redis的事务不保证原子性，只保证各个原子操作是一起执行的，中间不会被其他事务加塞，但是不保证这些原子操作一起成功或一起失败。</p><p><img src="`+p+`" alt="image-20250827211626905"></p><p>由上图可以看到，就算 <code>lpop age</code> 命令执行失败了，也不会影响到后续的命令执行。</p><p>而且开启事务后，执行的命令返回的都是 <code>QUEUED</code> ，表示的这些操作只是排好了队，但是还没执行，只有在发送了 <code>exec</code> 命令后，所有命令才会一起按循序执行。</p><h3 id="pipeline管道" tabindex="-1"><a class="header-anchor" href="#pipeline管道"><span>pipeline管道</span></a></h3><p>将多个指令打包一起发送给Redis服务端，减少了执行每个指令都会与服务端进行网络交互的时间。但是pipeline不具备原子性，虽然命令是一起打包发送给服务端的，但是并不能保证期间不被其他的操作命令加塞。</p><p>而且pipeline在执⾏过程中，会阻塞当前客户端。</p><p>适合在非热点时间将大批量不复杂的数据快速写入到Redis中。</p><p>案例：</p><p>command.txt</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">set</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incr</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incr</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">set</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">10</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incr</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">incr</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">age</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>redis执行命令</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">command.txt</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis-cli</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">123456pwd</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">--pipe</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="lua脚本" tabindex="-1"><a class="header-anchor" href="#lua脚本"><span>lua脚本</span></a></h3><blockquote><p>lua脚本在线调试网站： https://wiki.luatos.com/index.html</p></blockquote><p>lua语言是单线程模式的，所以在redis中执行lua脚本天然就是原子性的。</p><p>eval执行lua脚本</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">eval</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">return</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{KEYS[1],KEYS[2],ARGV[1],ARGV[2]}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">key1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">key2</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">param1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">param2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>第三个参数为从第三个参数往后多少个参数是Redis的键名参数，剩余的就是附加参数。</p><p>在lua脚本中，可以使用redis.call函数来调用Redis的命令。</p><p>例如</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">set</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count_key</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">10</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">eval</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">local</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">tmp</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">redis.call(&#39;get&#39;,</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KEYS[1])</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">local</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">tonumber(tmp)</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">local</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">b</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">tonumber(ARGV[1])</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">if</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&gt;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">b</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">then</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">redis.call(&#39;set&#39;,</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KEYS[1],</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">a)</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">return</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">end</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">redis.call(&#39;set&#39;,</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KEYS[1],</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ARGV[1])</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">return</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count_key</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">20</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+l+'" alt="image-20250827224341750"></p><h2 id="redis使用单线程为主的原因总结" tabindex="-1"><a class="header-anchor" href="#redis使用单线程为主的原因总结"><span>redis使用单线程为主的原因总结</span></a></h2><p>2小时05分左右</p><p>redis没有完全不考虑多线程，将flush all，AOF等耗时的操作放到多线程上，更利于发挥多线程的优势。</p><p>redis经过验证性能瓶颈不是在CPU上面，而是在内存、网络。只用单核性能已经足够高了（在数据结构方面做了很多优化）。所以redis综合考虑还是坚持了以单线程为主的线程模型。</p>',30)]))}const d=a(t,[["render",h],["__file","index.html.vue"]]),r=JSON.parse('{"path":"/interview/bka3a4x5/","title":"深入理解Redis线程模型","lang":"zh-CN","frontmatter":{"title":"深入理解Redis线程模型","createTime":"2025/08/26 20:01:43","permalink":"/interview/bka3a4x5/","description":"Redis保持原子性操作方式 事务 redis的事务和mysql的事务不一样，redis的事务不保证原子性，只保证各个原子操作是一起执行的，中间不会被其他事务加塞，但是不保证这些原子操作一起成功或一起失败。 image-20250827211626905 由上图可以看到，就算 lpop age 命令执行失败了，也不会影响到后续的命令执行。 而且开启事务...","head":[["meta",{"property":"og:url","content":"https://blog.gaohan.asia/interview/bka3a4x5/"}],["meta",{"property":"og:site_name","content":"云泽汇码"}],["meta",{"property":"og:title","content":"深入理解Redis线程模型"}],["meta",{"property":"og:description","content":"Redis保持原子性操作方式 事务 redis的事务和mysql的事务不一样，redis的事务不保证原子性，只保证各个原子操作是一起执行的，中间不会被其他事务加塞，但是不保证这些原子操作一起成功或一起失败。 image-20250827211626905 由上图可以看到，就算 lpop age 命令执行失败了，也不会影响到后续的命令执行。 而且开启事务..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-28T07:40:52.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-28T07:40:52.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"深入理解Redis线程模型\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-08-28T07:40:52.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":2.25,"words":676},"git":{"updatedTime":1756366852000,"contributors":[{"name":"yunze","username":"yunze","email":"834363368@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/yunze?v=4","url":"https://github.com/yunze"}]},"autoDesc":true,"filePathRelative":"notes/interview/2.Redis/2.深入理解Redis线程模型.md"}');export{d as comp,r as data};
