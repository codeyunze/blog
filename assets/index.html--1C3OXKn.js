import{_ as d,e as r,f as a,g as n,h as p,i as e,j as i,r as l,o as h}from"./app-Cx_oisp2.js";const o="/assets/image-20240630172021306-BGzyn5U1.png",v="/assets/image-20240630184022756-BWQe1zVN.png",k="/assets/image-20240630184239241-CbJngvyX.png",m="/assets/image-20240630184352692-CIfUVP2O.png",u="/assets/image-20240630184416159-zYT3eH5p.png",b={};function g(y,s){const c=l("RouteLink"),t=l("font");return h(),r("div",null,[s[3]||(s[3]=a('<p>MySQL服务的主从架构是通过binlog日志文件来实现的。使用MySQL做读写分离配置时，就必须基于主从架构来搭建，主节点用来写入数据，从节点用来读取数据。</p><ol><li>在主服务节点上开启binlog日志，用来记录每一步数据库的操作。</li><li>然后在从服务节点上，就会有一个IO线程，负责跟主服务建立一个TCP连接，用来请求主服务，获取最新的binlog日志。</li><li>主服务节点上会有一个IO dump线程，专门负责讲binlog日志传输给从节点服务。</li><li>接着从节点服务的IO线程会把读取到的binlog日志数据写入自己的relay日志文件中。</li><li>然后从节点服务上另外一个线程会读取relay日志里的内容，进行操作重演，达到数据还原的目的。</li></ol><h2 id="复制数据同步类型" tabindex="-1"><a class="header-anchor" href="#复制数据同步类型"><span>复制数据同步类型</span></a></h2><p>在 MySQL 8.0中，除了内置的异步复制之外，还支持半同步复制。默认情况下，MySQL 采用异步复制的方式。</p><h3 id="异步复制" tabindex="-1"><a class="header-anchor" href="#异步复制"><span>异步复制</span></a></h3><p>异步复制是主库往binlog日志写记录，从库从binlog复制数据到relay中继日志是两个线程，异步的，互不等待。</p><blockquote><p>异步复制可能存在主从延迟，如果主节点宕机，可能会丢数据。</p></blockquote><h3 id="半步同步复制" tabindex="-1"><a class="header-anchor" href="#半步同步复制"><span>半步同步复制</span></a></h3><ul><li><p>异步复制是主节点在完成binlog日志写记录之后，还需要等待至少一个从节点完成数据同步的响应之后（或超时），才会响应请求。</p></li><li><p>而从节点只有在写入 relay-log 并完成刷盘之后，才会向主节点响应。</p></li><li><p>当从节点响应超时时，主节点会将同步机制退化为异步复制。在至少一个从节点恢复，并完成数据追赶后，主节点会将同步机制恢复为半同步复制。</p></li></ul><p>重要参数</p><p><strong>rpl_semi_sync_master_wait_slave_count：</strong> 等待数据复制到几个从节点再返回。这个数量配置的越 大，丢数据的风险越小，但是集群的性能和可用性就越差。（8.0.26之后改为 rpl_semi_sync_source_wait_for_replica_count）</p><p>**rpl_semi_sync_master_wait_point：**这个参数控制主库执行事务的线程，是在提交事务之前（AFTER_SYNC）等待复制，还是在提交事务之后（AFTER_COMMIT）等待复制。默认是 AFTER_SYNC，也就是先等待复制，再提交事务，这样就不会丢数据。（8.0.26之后改为rpl_semi_sync_source_wait_point）</p><h2 id="方案一-基于binlog日志复制事件主从复制方式" tabindex="-1"><a class="header-anchor" href="#方案一-基于binlog日志复制事件主从复制方式"><span>方案一：基于binlog日志复制事件主从复制方式</span></a></h2><h3 id="先安装单机版mysql数据库" tabindex="-1"><a class="header-anchor" href="#先安装单机版mysql数据库"><span>先安装单机版mysql数据库</span></a></h3>',14)),n("p",null,[s[1]||(s[1]=p("操作流程： ")),e(c,{to:"/database/107.MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2.html"},{default:i(()=>s[0]||(s[0]=[p("MySQL数据库安装部署")])),_:1})]),s[4]||(s[4]=a(`<h3 id="主节点" tabindex="-1"><a class="header-anchor" href="#主节点"><span>主节点</span></a></h3><h4 id="master主节点服务的my-cnf配置" tabindex="-1"><a class="header-anchor" href="#master主节点服务的my-cnf配置"><span>master主节点服务的my.cnf配置</span></a></h4><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>#</span><span class="space"> </span><span>For</span><span class="space"> </span><span>advice</span><span class="space"> </span><span>on</span><span class="space"> </span><span>how</span><span class="space"> </span><span>to</span><span class="space"> </span><span>change</span><span class="space"> </span><span>settings</span><span class="space"> </span><span>please</span><span class="space"> </span><span>see</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>http://dev.mysql.com/doc/refman/8.0/en/server-configuration-defaults.html</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[mysqld]</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>主库需要和从库不一致</span></span>
<span class="line"><span>server-id=47</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>开启binlog日志</span></span>
<span class="line"><span>log_bin=master-bin</span></span>
<span class="line"><span>log_bin-index=master-bin.index</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>设置服务连接端口</span></span>
<span class="line"><span>port=3306</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>跳过域名解析，只接受客户端使用ip地址进行认证</span></span>
<span class="line"><span>skip-name-resolve</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>and</span><span class="space"> </span><span>set</span><span class="space"> </span><span>to</span><span class="space"> </span><span>the</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>of</span><span class="space"> </span><span>RAM</span><span class="space"> </span><span>for</span><span class="space"> </span><span>the</span><span class="space"> </span><span>most</span><span class="space"> </span><span>important</span><span class="space"> </span><span>data</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>cache</span><span class="space"> </span><span>in</span><span class="space"> </span><span>MySQL.</span><span class="space"> </span><span>Start</span><span class="space"> </span><span>at</span><span class="space"> </span><span>70%</span><span class="space"> </span><span>of</span><span class="space"> </span><span>total</span><span class="space"> </span><span>RAM</span><span class="space"> </span><span>for</span><span class="space"> </span><span>dedicated</span><span class="space"> </span><span>server,</span><span class="space"> </span><span>else</span><span class="space"> </span><span>10%.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>innodb_buffer_pool_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>128M</span></span>
<span class="line"><span>innodb_buffer_pool_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>1024M</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>the</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>&quot;#</span><span class="space"> </span><span>&quot;</span><span class="space"> </span><span>to</span><span class="space"> </span><span>disable</span><span class="space"> </span><span>binary</span><span class="space"> </span><span>logging</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Binary</span><span class="space"> </span><span>logging</span><span class="space"> </span><span>captures</span><span class="space"> </span><span>changes</span><span class="space"> </span><span>between</span><span class="space"> </span><span>backups</span><span class="space"> </span><span>and</span><span class="space"> </span><span>is</span><span class="space"> </span><span>enabled</span><span class="space"> </span><span>by</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>default.</span><span class="space"> </span><span>It&#39;s</span><span class="space"> </span><span>default</span><span class="space"> </span><span>setting</span><span class="space"> </span><span>is</span><span class="space"> </span><span>log_bin=binlog</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>disable_log_bin</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>to</span><span class="space"> </span><span>set</span><span class="space"> </span><span>options</span><span class="space"> </span><span>mainly</span><span class="space"> </span><span>useful</span><span class="space"> </span><span>for</span><span class="space"> </span><span>reporting</span><span class="space"> </span><span>servers.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>The</span><span class="space"> </span><span>server</span><span class="space"> </span><span>defaults</span><span class="space"> </span><span>are</span><span class="space"> </span><span>faster</span><span class="space"> </span><span>for</span><span class="space"> </span><span>transactions</span><span class="space"> </span><span>and</span><span class="space"> </span><span>fast</span><span class="space"> </span><span>SELECTs.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Adjust</span><span class="space"> </span><span>sizes</span><span class="space"> </span><span>as</span><span class="space"> </span><span>needed,</span><span class="space"> </span><span>experiment</span><span class="space"> </span><span>to</span><span class="space"> </span><span>find</span><span class="space"> </span><span>the</span><span class="space"> </span><span>optimal</span><span class="space"> </span><span>values.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>join_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>128M</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>sort_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>2M</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>read_rnd_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>2M</span></span>
<span class="line"><span>join_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>256KB</span></span>
<span class="line"><span>sort_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>512KB</span></span>
<span class="line"><span>read_rnd_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>256KB</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>to</span><span class="space"> </span><span>revert</span><span class="space"> </span><span>to</span><span class="space"> </span><span>previous</span><span class="space"> </span><span>value</span><span class="space"> </span><span>for</span><span class="space"> </span><span>default_authentication_plugin,</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>this</span><span class="space"> </span><span>will</span><span class="space"> </span><span>increase</span><span class="space"> </span><span>compatibility</span><span class="space"> </span><span>with</span><span class="space"> </span><span>older</span><span class="space"> </span><span>clients.</span><span class="space"> </span><span>For</span><span class="space"> </span><span>background,</span><span class="space"> </span><span>see:</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>default-authentication-plugin=mysql_native_password</span></span>
<span class="line"><span></span></span>
<span class="line"><span>datadir=/var/lib/mysql</span></span>
<span class="line"><span>socket=/var/lib/mysql/mysql.sock</span></span>
<span class="line"><span></span></span>
<span class="line"><span>log-error=/var/log/mysqld.log</span></span>
<span class="line"><span>pid-file=/var/run/mysqld/mysqld.pid</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#</span><span class="space"> </span><span>允许最大连接数</span></span>
<span class="line"><span>max_connections=200</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统</span></span>
<span class="line"><span>max_connect_errors=10</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>服务端使用的字符集默认为UTF8</span></span>
<span class="line"><span>character-set-server=utf8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="启动主节点的mysql服务" tabindex="-1"><a class="header-anchor" href="#启动主节点的mysql服务"><span>启动主节点的mysql服务</span></a></h4><p>启动服务命令</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">restart</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>重启服务命令</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">start</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看服务状态</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">status</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="master-主节点相关命令" tabindex="-1"><a class="header-anchor" href="#master-主节点相关命令"><span>master 主节点相关命令</span></a></h4><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">查看主节点信息</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">show</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">master</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">status</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">创建指定用户</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">create</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">user</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&#39;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">replication_user</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&#39;@</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">%</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">identified</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">by</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">acd5432</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">授予指定用户复制所有数据库和表的相关操作（一般用于主从复制）</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">grant</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">replication</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">on</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">to</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">replication_user</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">@</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">%</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">刷新权限以确保立即生效</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">flush</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">privileges</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从节点" tabindex="-1"><a class="header-anchor" href="#从节点"><span>从节点</span></a></h3><h4 id="slave从节点服务的my-cnf配置" tabindex="-1"><a class="header-anchor" href="#slave从节点服务的my-cnf配置"><span>slave从节点服务的my.cnf配置</span></a></h4><div class="language-cnf line-numbers-mode" data-ext="cnf" data-title="cnf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[mysqld]</span></span>
<span class="line"><span>#主库和从库要不一致</span></span>
<span class="line"><span>server-id=48</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>打开MySQL中继日志</span></span>
<span class="line"><span>relay-log-index=slave-relay-bin.index</span></span>
<span class="line"><span>relay-log=slave-relay-bin</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>打开从服务二进制日志</span></span>
<span class="line"><span>log-bin=mysql-bin</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>log-slave-updates=1</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>port=3306</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>and</span><span class="space"> </span><span>set</span><span class="space"> </span><span>to</span><span class="space"> </span><span>the</span><span class="space"> </span><span>amount</span><span class="space"> </span><span>of</span><span class="space"> </span><span>RAM</span><span class="space"> </span><span>for</span><span class="space"> </span><span>the</span><span class="space"> </span><span>most</span><span class="space"> </span><span>important</span><span class="space"> </span><span>data</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>cache</span><span class="space"> </span><span>in</span><span class="space"> </span><span>MySQL.</span><span class="space"> </span><span>Start</span><span class="space"> </span><span>at</span><span class="space"> </span><span>70%</span><span class="space"> </span><span>of</span><span class="space"> </span><span>total</span><span class="space"> </span><span>RAM</span><span class="space"> </span><span>for</span><span class="space"> </span><span>dedicated</span><span class="space"> </span><span>server,</span><span class="space"> </span><span>else</span><span class="space"> </span><span>10%.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>innodb_buffer_pool_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>128M</span></span>
<span class="line"><span>innodb_buffer_pool_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>512M</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>the</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>&quot;#</span><span class="space"> </span><span>&quot;</span><span class="space"> </span><span>to</span><span class="space"> </span><span>disable</span><span class="space"> </span><span>binary</span><span class="space"> </span><span>logging</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Binary</span><span class="space"> </span><span>logging</span><span class="space"> </span><span>captures</span><span class="space"> </span><span>changes</span><span class="space"> </span><span>between</span><span class="space"> </span><span>backups</span><span class="space"> </span><span>and</span><span class="space"> </span><span>is</span><span class="space"> </span><span>enabled</span><span class="space"> </span><span>by</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>default.</span><span class="space"> </span><span>It&#39;s</span><span class="space"> </span><span>default</span><span class="space"> </span><span>setting</span><span class="space"> </span><span>is</span><span class="space"> </span><span>log_bin=binlog</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>disable_log_bin</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>to</span><span class="space"> </span><span>set</span><span class="space"> </span><span>options</span><span class="space"> </span><span>mainly</span><span class="space"> </span><span>useful</span><span class="space"> </span><span>for</span><span class="space"> </span><span>reporting</span><span class="space"> </span><span>servers.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>The</span><span class="space"> </span><span>server</span><span class="space"> </span><span>defaults</span><span class="space"> </span><span>are</span><span class="space"> </span><span>faster</span><span class="space"> </span><span>for</span><span class="space"> </span><span>transactions</span><span class="space"> </span><span>and</span><span class="space"> </span><span>fast</span><span class="space"> </span><span>SELECTs.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Adjust</span><span class="space"> </span><span>sizes</span><span class="space"> </span><span>as</span><span class="space"> </span><span>needed,</span><span class="space"> </span><span>experiment</span><span class="space"> </span><span>to</span><span class="space"> </span><span>find</span><span class="space"> </span><span>the</span><span class="space"> </span><span>optimal</span><span class="space"> </span><span>values.</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>join_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>128M</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>sort_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>2M</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>read_rnd_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>2M</span></span>
<span class="line"><span>join_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>256KB</span></span>
<span class="line"><span>sort_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>512KB</span></span>
<span class="line"><span>read_rnd_buffer_size</span><span class="space"> </span><span>=</span><span class="space"> </span><span>256KB</span></span>
<span class="line"><span>#</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>Remove</span><span class="space"> </span><span>leading</span><span class="space"> </span><span>#</span><span class="space"> </span><span>to</span><span class="space"> </span><span>revert</span><span class="space"> </span><span>to</span><span class="space"> </span><span>previous</span><span class="space"> </span><span>value</span><span class="space"> </span><span>for</span><span class="space"> </span><span>default_authentication_plugin,</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>this</span><span class="space"> </span><span>will</span><span class="space"> </span><span>increase</span><span class="space"> </span><span>compatibility</span><span class="space"> </span><span>with</span><span class="space"> </span><span>older</span><span class="space"> </span><span>clients.</span><span class="space"> </span><span>For</span><span class="space"> </span><span>background,</span><span class="space"> </span><span>see:</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_default_authentication_plugin</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>default-authentication-plugin=mysql_native_password</span></span>
<span class="line"><span></span></span>
<span class="line"><span>datadir=/var/lib/mysql</span></span>
<span class="line"><span>socket=/var/lib/mysql/mysql.sock</span></span>
<span class="line"><span></span></span>
<span class="line"><span>log-error=/var/log/mysqld.log</span></span>
<span class="line"><span>pid-file=/var/run/mysqld/mysqld.pid</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>#</span><span class="space"> </span><span>允许最大连接数</span></span>
<span class="line"><span>max_connections=200</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>#</span><span class="space"> </span><span>允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统</span></span>
<span class="line"><span>max_connect_errors=10</span></span>
<span class="line"><span>#</span><span class="space"> </span><span>#</span><span class="space"> </span><span>服务端使用的字符集默认为UTF8</span></span>
<span class="line"><span>character-set-server=utf8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="启动从节点的mysql服务" tabindex="-1"><a class="header-anchor" href="#启动从节点的mysql服务"><span>启动从节点的mysql服务</span></a></h4><p>启动服务命令</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">restart</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>重启服务命令</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">start</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看服务状态</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysqld</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">status</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="slave-从节点相关命令" tabindex="-1"><a class="header-anchor" href="#slave-从节点相关命令"><span>slave 从节点相关命令</span></a></h4>`,23)),n("p",null,[n("strong",null,[e(t,{style:{color:"red"}},{default:i(()=>s[2]||(s[2]=[p("注意事项：")])),_:1})])]),s[5]||(s[5]=a(`<blockquote><p>下面命令中的 <code>change master</code> 指令中需要指定的master_log_file和master_log_pos必须和上面master主节点中使用 <code>show master status</code> 命令查到的保持一致。</p></blockquote><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">设置同步主节点</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">change</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">master</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">to</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_host</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">10.0.20.12</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_port</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3306</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_user</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">replication_user</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_password</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">acd5432</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_log_file</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">master-bin.000002</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master_log_pos</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">6580</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">get_master_public_key</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">开启slave从节点</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">start</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">关闭从节点</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">stop</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">#</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">查看从节点的主从同步状态</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">show</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">status</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+o+'" alt="image-20240630172021306"></p><h3 id="主从集群搭建完毕" tabindex="-1"><a class="header-anchor" href="#主从集群搭建完毕"><span>主从集群搭建完毕</span></a></h3><h4 id="验证主从集群" tabindex="-1"><a class="header-anchor" href="#验证主从集群"><span>验证主从集群</span></a></h4><p>在master主节点进行数据操作，会同步更新到从节点。</p><h5 id="测试1" tabindex="-1"><a class="header-anchor" href="#测试1"><span>测试1</span></a></h5><p>在主节点创建一个表</p><p><img src="'+v+'" alt="image-20240630184022756"></p><p>在从节点查看表</p><p><img src="'+k+'" alt="image-20240630184239241"></p><h5 id="测试2" tabindex="-1"><a class="header-anchor" href="#测试2"><span>测试2</span></a></h5><p>在主节点新增数据</p><p><img src="'+m+'" alt="image-20240630184352692"></p><p>在从节点查看数据</p><p><img src="'+u+`" alt="image-20240630184416159"></p><h4 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项"><span>注意事项</span></a></h4><p>主从集群不能在从节点进行数据操作，从节点的数据是不会反向同步到主节点的，所以一般以从节点作为 <code>读库</code> ，主节点作为 <code>写库</code> ,这就是常说的读写分离。</p><h3 id="集群扩容" tabindex="-1"><a class="header-anchor" href="#集群扩容"><span>集群扩容</span></a></h3><p>现在已经存在了master主节点，且此时master主节点已经有了很多数据，此时再想给这个master主节点加上一个slave从节点，会有如下问题，之前数据是无法通过binlog来恢复的，这时候加新的slave节点时，需要在从节点执行 <code>change master</code> 命令前，额外增加一个数据复制操作，需要将master主节点当前的数据全部手动同步到slave节点。（最好停止所有应用服务再去操作，防止手动数据同步期间还有新的数据入库）</p><p>手动同步数据操作方式如下</p><p><strong>在master主节点导出需要同步的数据库数据</strong></p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">mysqldump</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">u</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">root</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">p</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">数据库名称</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">数据库名称_backup</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>在slave从节点执行master主节点导出的脚本</strong></p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">mysql</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">u</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">root</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">p</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">数据库名称</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">数据库名称_backup</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>将历史的业务数据导入到slave从节点之后，从节点就可以再继续按照上文的步骤执行 <code>change master</code> 等命令了。</p><h3 id="全库同步和部分同步" tabindex="-1"><a class="header-anchor" href="#全库同步和部分同步"><span>全库同步和部分同步</span></a></h3><p>上文目前的配置是slave从节点是会同步master主节点的全库，在实际环境中可能只需要同步master主节点的其中一个或数个库</p><p>操作方式如下：</p><p>先在masterr主节点的mysql的 <code>my.cnf</code>（默认地址：/etc/my.cnf） 里加上如下配置</p><div class="language-cnf line-numbers-mode" data-ext="cnf" data-title="cnf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>#</span><span class="space"> </span><span>设置只同步库名为dbName1和dbName2的库</span><span class="space"> </span></span>
<span class="line"><span>binlog-do-db=dbName1</span></span>
<span class="line"><span>binlog-do-db=dbName2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在slave从节点的mysql的 <code>my.cnf</code>（默认地址：/etc/my.cnf） 里加上如下配置</p><div class="language-cnf line-numbers-mode" data-ext="cnf" data-title="cnf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>replicate-do-db=dbName1</span></span>
<span class="line"><span>replicate-do-db=dbName2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>如果masterr主节点和slave从节点的库名不相同，可在slave从节点的mysql的 <code>my.cnf</code> 添加如下配置</p><p>replicate­-rewrite­-db=dbName &gt; dbName1</p><p>注意：该在MySQL的新版本中已经被废弃，在MySQL 5.7及以后的版本中，使用这个选项可能会收到警告，并且在未来的MySQL版本中可能会被移除。所以最好保持主从数据库的库名一致。</p></blockquote><p>如果不是 dbName1 库的所有表数据都同步，只需要需要同步指定的数据表，则可以在slave从节点的mysql的 <code>my.cnf</code> 配置文件中加上如下配置</p><div class="language-cnf line-numbers-mode" data-ext="cnf" data-title="cnf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>#</span><span class="space"> </span><span>如果没有指定则默认是全部表同步的（下面配置只同步dbName1库的tableName1和tableName2两个表）</span></span>
<span class="line"><span>replicate-wild-do-table=dbName1.tableName1</span></span>
<span class="line"><span>replicate-wild-do-table=dbName1.tableName2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="方案二-基于全局事务标识符-gtid-源-副本复制模式" tabindex="-1"><a class="header-anchor" href="#方案二-基于全局事务标识符-gtid-源-副本复制模式"><span>方案二：基于全局事务标识符(GTID)源-副本复制模式</span></a></h2><p>Replication（复制）使来自一个MySQL数据库服务器（称为源（Source））的数据能够复制到一个或多个 MySQL 服务器（称为副本（Replica））。</p><p>GTID是一个基于原始mysql服务器生成的一个已经被成功执行的全局事务ID，它由服务器ID以及事务 ID组合而成。</p><p>一个GTID在一个服务器上只执行一次，避免重复执行导致数据混乱或者主从不一致。</p><p>在传统的replica端，binlog是不用开启的，但是 <strong>在GTID中replica端的binlog是必须开启</strong> 的，目的是记录执行过的GTID（强制）。</p><p>GTID表示为一对坐标，由冒号(:)分隔，如下所示:</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">GTID</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">=</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">source_id:transaction_id</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其中 <code>source_id</code> 即源服务器唯一的 <code>server_uuid</code> 。</p><p><code>transaction_id</code> 是一个序列号，由事务在源（主节点）上提交的顺序决定。序列号的上限是有符号64位整数（2^63-1）</p><p>GTID存储在mysql数据库中名为gtid_executed的表中。</p><h3 id="gtid的优势" tabindex="-1"><a class="header-anchor" href="#gtid的优势"><span>GTID的优势</span></a></h3><ol><li><p>更简单的实现故障转移，不用以前那样在需要找位点（log_file 和 log_pos）。</p></li><li><p>更简单的搭建主从复制。</p></li><li><p>比传统的复制更加安全。</p></li><li><p>GTID 是连续的没有空洞的，保证数据的一致性，零丢失。</p></li></ol><h3 id="gtid-同步方案和位点同步的方案区别" tabindex="-1"><a class="header-anchor" href="#gtid-同步方案和位点同步的方案区别"><span>GTID 同步方案和位点同步的方案区别</span></a></h3><ul><li>位点同步方案是通过人工在从库上指定哪个位点，主库就发哪个位点，不做日志的完整性判断。</li><li>GTID 方案是通过主库来自动计算位点的，不需要人工去设置位点，对运维人员友好。</li></ul><h2 id="自动清理binlog日志" tabindex="-1"><a class="header-anchor" href="#自动清理binlog日志"><span>自动清理binlog日志</span></a></h2><p>在实际环境中binlog日志是很大，为防止大量占用磁盘资源，可以在master主节点的 <code>my.cnf</code> 加上如下配置</p><div class="language-cnf line-numbers-mode" data-ext="cnf" data-title="cnf"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>#</span><span class="space"> </span><span>设置只保留7天的二进制日志</span></span>
<span class="line"><span>expire-logs-days=7</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div>`,53))])}const D=d(b,[["render",g],["__file","index.html.vue"]]),E=JSON.parse('{"path":"/interview/g0w7yd3v/","title":"MySQL主从复制","lang":"zh-CN","frontmatter":{"title":"MySQL主从复制","createTime":"2025/08/24 22:31:28","permalink":"/interview/g0w7yd3v/","tags":["数据库","MySQL","主从"],"description":"MySQL服务的主从架构是通过binlog日志文件来实现的。使用MySQL做读写分离配置时，就必须基于主从架构来搭建，主节点用来写入数据，从节点用来读取数据。 在主服务节点上开启binlog日志，用来记录每一步数据库的操作。 然后在从服务节点上，就会有一个IO线程，负责跟主服务建立一个TCP连接，用来请求主服务，获取最新的binlog日志。 主服务节点...","head":[["meta",{"property":"og:url","content":"https://blog.gaohan.asia/interview/g0w7yd3v/"}],["meta",{"property":"og:site_name","content":"云泽汇码"}],["meta",{"property":"og:title","content":"MySQL主从复制"}],["meta",{"property":"og:description","content":"MySQL服务的主从架构是通过binlog日志文件来实现的。使用MySQL做读写分离配置时，就必须基于主从架构来搭建，主节点用来写入数据，从节点用来读取数据。 在主服务节点上开启binlog日志，用来记录每一步数据库的操作。 然后在从服务节点上，就会有一个IO线程，负责跟主服务建立一个TCP连接，用来请求主服务，获取最新的binlog日志。 主服务节点..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-24T15:44:21.000Z"}],["meta",{"property":"article:tag","content":"数据库"}],["meta",{"property":"article:tag","content":"MySQL"}],["meta",{"property":"article:tag","content":"主从"}],["meta",{"property":"article:modified_time","content":"2025-08-24T15:44:21.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL主从复制\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-08-24T15:44:21.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":9.29,"words":2786},"git":{"updatedTime":1756050261000,"contributors":[{"name":"yunze","username":"yunze","email":"56632502+YUNZE-GH@users.noreply.github.com","commits":1,"avatar":"https://avatars.githubusercontent.com/yunze?v=4","url":"https://github.com/yunze"},{"name":"yunze","username":"yunze","email":"834363368@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/yunze?v=4","url":"https://github.com/yunze"}]},"autoDesc":true,"filePathRelative":"notes/interview/1.MySQL/9.MySQL主从复制.md"}');export{D as comp,E as data};
