import{_ as a,e as p,f as n,o as e}from"./app-Cx_oisp2.js";const c={};function l(i,s){return e(),p("div",null,s[0]||(s[0]=[n(`<p>Redis集群的架构是通过哈希槽算法实现数据分片存储，以及主从结构解决读写分离和负载均衡问题。集群节点间的通信机制为gossip协议，负责处理集群的故障检测与恢复流程，以及集群的扩容、收缩操作。</p><h1 id="redis的集群搭建配置" tabindex="-1"><a class="header-anchor" href="#redis的集群搭建配置"><span>Redis的集群搭建配置</span></a></h1><blockquote><p>此案例在3台虚拟机上每台机搭建一个master主节点和一个slave从节点，共3个master节点，3个slave从节点，共计6个redis节点；（集群至少需要存在3个主节点，如果只有2个，则其中一个主节点挂了之后，只剩下一个主节点是无法为挂掉主节点的从节点进行选举的，具体原由下文的“集群的选举原理分析”里有详细说明）</p><p>三台虚拟机IP和端口分配如下：</p><p>192.168.3.39：8001、8004</p><p>192.168.3.129：8002、8005</p><p>192.168.3.130：8003、8006</p><p>本文以 <a href="./121.Redis%E7%9A%84%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4">Redis的单机安装步骤.md</a> 与 <a href="./122.Redis%E7%9A%84%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E9%85%8D%E7%BD%AE">Redis的主从架构配置</a> 为基础进行集群搭建</p></blockquote><h2 id="搭建集群" tabindex="-1"><a class="header-anchor" href="#搭建集群"><span>搭建集群</span></a></h2><h3 id="_1-准备物理文件存储目录" tabindex="-1"><a class="header-anchor" href="#_1-准备物理文件存储目录"><span>1. 准备物理文件存储目录</span></a></h3><p>在第一台192.168.3.39虚拟机下创建其物理文件存储目录文件夹</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>mkdir</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>/home/yunze/bin/redis/redis-5.0.14/data/cluster</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>cd</span><span class="space"> </span><span>/home/yunze/bin/redis/redis-5.0.14/data/cluster</span></span>
<span class="line"><span>mkdir</span><span class="space"> </span><span>8001</span><span class="space"> </span><span>8004</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-复制redis-conf配置文件" tabindex="-1"><a class="header-anchor" href="#_2-复制redis-conf配置文件"><span>2. 复制redis.conf配置文件</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>cp</span><span class="space"> </span><span>redis.conf</span><span class="space"> </span><span>redis-cluster-8001.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-调整配置文件" tabindex="-1"><a class="header-anchor" href="#_3-调整配置文件"><span>3. 调整配置文件</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>vim</span><span class="space"> </span><span>redis-cluster-8001.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>配置信息如下：</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">端口设置</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">port</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">8001</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">设置redis为后台启动，也就是关闭会话窗口后不会自动关闭服务</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">daemonize</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">将端口号追加命名到pidfile配置的文件</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">pidfile</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/var/run/redis_cluster_8001.pid</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">logfile</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cluster_8001.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">设置集群节点的数据文件存储路径</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">dir</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/home/yunze/bin/redis/redis-5.0.14/data/cluster/8001</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">启动集群模式</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cluster-enabled</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">集群节点信息文件</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cluster-config-file</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">nodes-8001.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">集群节点无法访问多少毫秒之后会被判定为故障</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cluster-node-timeout</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">15000</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">注释掉bind配置，后续可改配置为局域网IP</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">bind</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">127.0.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">关闭redis的自我保护模式，如果开启，则只有本机才可以访问redis</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">protected-mode</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">no</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">开启AOF，每一次redis操作命令都会被追加到AOF文件末尾，当redis重新启动时，程序可以通过重新执行AOF文件中的命令来达到重建数据集的目的</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">appendonly</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">设置redis的访问密码</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">requirepass</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">foobared</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">设置集群节点间的访问密码</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">masterauth</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">foobared</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>192.168.3.39虚拟机的8001节点配置文件准备完毕！</p><h3 id="_4-准备其他节点的配置文件" tabindex="-1"><a class="header-anchor" href="#_4-准备其他节点的配置文件"><span>4. 准备其他节点的配置文件</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>cp</span><span class="space"> </span><span>redis-cluster-8001.conf</span><span class="space"> </span><span>redis-cluster-8004.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vim</span><span class="space"> </span><span>redis-cluster-8004.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#</span><span class="space"> </span><span>可使用如下命令进行配置信息批量替换</span></span>
<span class="line"><span>:%s/8001/8004/g</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>其他两台虚拟机同理，注意端口号调整，然后再重复上述1~4步操作即可！</strong></p><h3 id="_5-关闭防火墙" tabindex="-1"><a class="header-anchor" href="#_5-关闭防火墙"><span>5. 关闭防火墙</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>#</span><span class="space"> </span><span>查看防火墙状态</span></span>
<span class="line"><span>systemctl</span><span class="space"> </span><span>status</span><span class="space"> </span><span>firewalld</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#</span><span class="space"> </span><span>关闭防火墙</span></span>
<span class="line"><span>systemctl</span><span class="space"> </span><span>stop</span><span class="space"> </span><span>firewalld</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#</span><span class="space"> </span><span>禁止防火墙开机自启动</span></span>
<span class="line"><span>systemctl</span><span class="space"> </span><span>disable</span><span class="space"> </span><span>firewalld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重点</strong> ：</p><p>如果不关闭防火墙，则需配置打开6个redis实例所配置的port端口和集群节点gossip通信端口（默认是redis端口号加上10000）；</p><p><u>例：redis配置的端口为6379，则gossip端口为16379；redis配置的端口为8001，则gossip端口为18001；</u></p><h3 id="_6-分别启动redis实例" tabindex="-1"><a class="header-anchor" href="#_6-分别启动redis实例"><span>6. 分别启动redis实例</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8001.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8002.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8003.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8004.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8005.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8006.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-查看服务是否启动成功" tabindex="-1"><a class="header-anchor" href="#_7-查看服务是否启动成功"><span>7. 查看服务是否启动成功</span></a></h3><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>ps</span><span class="space"> </span><span>-ef</span><span class="space"> </span><span>|</span><span class="space"> </span><span>grep</span><span class="space"> </span><span>redis</span></span>
<span class="line"><span>yunze</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>4847</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span class="space"> </span><span>0</span><span class="space"> </span><span>23:10</span><span class="space"> </span><span>?</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>00:00:02</span><span class="space"> </span><span>src/redis-server</span><span class="space"> </span><span>*:8001</span><span class="space"> </span><span>[cluster]</span></span>
<span class="line"><span>yunze</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>4862</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span class="space"> </span><span>0</span><span class="space"> </span><span>23:10</span><span class="space"> </span><span>?</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>00:00:02</span><span class="space"> </span><span>src/redis-server</span><span class="space"> </span><span>*:8004</span><span class="space"> </span><span>[cluster]</span></span>
<span class="line"><span>yunze</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>5088</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>2809</span><span class="space"> </span><span class="space"> </span><span>0</span><span class="space"> </span><span>23:27</span><span class="space"> </span><span>pts/0</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>00:00:00</span><span class="space"> </span><span>grep</span><span class="space"> </span><span>--color=auto</span><span class="space"> </span><span>redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-使用redis-cli创建redis集群" tabindex="-1"><a class="header-anchor" href="#_8-使用redis-cli创建redis集群"><span>8. 使用redis-cli创建redis集群</span></a></h3><blockquote><p><strong>注意：集群创建成功之后，如果关闭了集群，下次不需要再重新执行该命令，将集群的各个实例分别启动起来即可；</strong></p></blockquote><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>create</span><span class="space"> </span><span>--cluster-replicas</span><span class="space"> </span><span>1</span><span class="space"> </span><span>192.168.3.39:8001</span><span class="space"> </span><span>192.168.3.129:8002</span><span class="space"> </span><span>192.168.3.130:8003</span><span class="space"> </span><span>192.168.3.39:8004</span><span class="space"> </span><span>192.168.3.129:8005</span><span class="space"> </span><span>192.168.3.130:8006</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>--cluster-replicas 1</code>意为集群里一个主节点的从节点数量限制为1；</p><p>例：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>create</span><span class="space"> </span><span>--cluster-replicas</span><span class="space"> </span><span>1</span><span class="space"> </span><span>192.168.3.39:8001</span><span class="space"> </span><span>192.168.3.129:8002</span><span class="space"> </span><span>192.168.3.130:8003</span><span class="space"> </span><span>192.168.3.39:8004</span><span class="space"> </span><span>192.168.3.129:8005</span><span class="space"> </span><span>192.168.3.130:8006</span></span>
<span class="line"><span>Warning:</span><span class="space"> </span><span>Using</span><span class="space"> </span><span>a</span><span class="space"> </span><span>password</span><span class="space"> </span><span>with</span><span class="space"> </span><span>&#39;-a&#39;</span><span class="space"> </span><span>or</span><span class="space"> </span><span>&#39;-u&#39;</span><span class="space"> </span><span>option</span><span class="space"> </span><span>on</span><span class="space"> </span><span>the</span><span class="space"> </span><span>command</span><span class="space"> </span><span>line</span><span class="space"> </span><span>interface</span><span class="space"> </span><span>may</span><span class="space"> </span><span>not</span><span class="space"> </span><span>be</span><span class="space"> </span><span>safe.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Performing</span><span class="space"> </span><span>hash</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>allocation</span><span class="space"> </span><span>on</span><span class="space"> </span><span>6</span><span class="space"> </span><span>nodes...</span></span>
<span class="line"><span>Master[0]</span><span class="space"> </span><span>-&gt;</span><span class="space"> </span><span>Slots</span><span class="space"> </span><span>0</span><span class="space"> </span><span>-</span><span class="space"> </span><span>5460</span></span>
<span class="line"><span>Master[1]</span><span class="space"> </span><span>-&gt;</span><span class="space"> </span><span>Slots</span><span class="space"> </span><span>5461</span><span class="space"> </span><span>-</span><span class="space"> </span><span>10922</span></span>
<span class="line"><span>Master[2]</span><span class="space"> </span><span>-&gt;</span><span class="space"> </span><span>Slots</span><span class="space"> </span><span>10923</span><span class="space"> </span><span>-</span><span class="space"> </span><span>16383</span></span>
<span class="line"><span>Adding</span><span class="space"> </span><span>replica</span><span class="space"> </span><span>192.168.3.129:8005</span><span class="space"> </span><span>to</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span>Adding</span><span class="space"> </span><span>replica</span><span class="space"> </span><span>192.168.3.130:8006</span><span class="space"> </span><span>to</span><span class="space"> </span><span>192.168.3.129:8002</span></span>
<span class="line"><span>Adding</span><span class="space"> </span><span>replica</span><span class="space"> </span><span>192.168.3.39:8004</span><span class="space"> </span><span>to</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[0-5460]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[5461-10922]</span><span class="space"> </span><span>(5462</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[10923-16383]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span></span>
<span class="line"><span>Can</span><span class="space"> </span><span>I</span><span class="space"> </span><span>set</span><span class="space"> </span><span>the</span><span class="space"> </span><span>above</span><span class="space"> </span><span>configuration?</span><span class="space"> </span><span>(type</span><span class="space"> </span><span>&#39;yes&#39;</span><span class="space"> </span><span>to</span><span class="space"> </span><span>accept):</span><span class="space"> </span><span>yes</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Nodes</span><span class="space"> </span><span>configuration</span><span class="space"> </span><span>updated</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Assign</span><span class="space"> </span><span>a</span><span class="space"> </span><span>different</span><span class="space"> </span><span>config</span><span class="space"> </span><span>epoch</span><span class="space"> </span><span>to</span><span class="space"> </span><span>each</span><span class="space"> </span><span>node</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Sending</span><span class="space"> </span><span>CLUSTER</span><span class="space"> </span><span>MEET</span><span class="space"> </span><span>messages</span><span class="space"> </span><span>to</span><span class="space"> </span><span>join</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster</span></span>
<span class="line"><span>Waiting</span><span class="space"> </span><span>for</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>to</span><span class="space"> </span><span>join</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Performing</span><span class="space"> </span><span>Cluster</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>(using</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.39:8001)</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[0-5460]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[10923-16383]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[5461-10922]</span><span class="space"> </span><span>(5462</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>nodes</span><span class="space"> </span><span>agree</span><span class="space"> </span><span>about</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>configuration.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>for</span><span class="space"> </span><span>open</span><span class="space"> </span><span>slots...</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>coverage...</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>16384</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>covered.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-验证集群" tabindex="-1"><a class="header-anchor" href="#_9-验证集群"><span>9. 验证集群</span></a></h3><p>访问任意客户端即可</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8001</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-查看集群信息" tabindex="-1"><a class="header-anchor" href="#_1-查看集群信息"><span>1. 查看集群信息</span></a></h4><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>info</span></span>
<span class="line"><span>cluster_state:ok</span></span>
<span class="line"><span>cluster_slots_assigned:16384</span></span>
<span class="line"><span>cluster_slots_ok:16384</span></span>
<span class="line"><span>cluster_slots_pfail:0</span></span>
<span class="line"><span>cluster_slots_fail:0</span></span>
<span class="line"><span>cluster_known_nodes:6</span></span>
<span class="line"><span>cluster_size:3</span></span>
<span class="line"><span>cluster_current_epoch:6</span></span>
<span class="line"><span>cluster_my_epoch:1</span></span>
<span class="line"><span>cluster_stats_messages_ping_sent:441</span></span>
<span class="line"><span>cluster_stats_messages_pong_sent:470</span></span>
<span class="line"><span>cluster_stats_messages_sent:911</span></span>
<span class="line"><span>cluster_stats_messages_ping_received:465</span></span>
<span class="line"><span>cluster_stats_messages_pong_received:441</span></span>
<span class="line"><span>cluster_stats_messages_meet_received:5</span></span>
<span class="line"><span>cluster_stats_messages_received:911</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-查看集群节点列表" tabindex="-1"><a class="header-anchor" href="#_2-查看集群节点列表"><span>2. 查看集群节点列表</span></a></h4><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>nodes</span></span>
<span class="line"><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005@18005</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422958898</span><span class="space"> </span><span>5</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004@18004</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422958000</span><span class="space"> </span><span>4</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001@18001</span><span class="space"> </span><span>myself,master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422958000</span><span class="space"> </span><span>1</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>0-5460</span></span>
<span class="line"><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006@18006</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422957000</span><span class="space"> </span><span>6</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003@18003</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422956000</span><span class="space"> </span><span>3</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>10923-16383</span></span>
<span class="line"><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002@18002</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1691422957892</span><span class="space"> </span><span>2</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>5461-10922</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>分析集群节点列表信息可以得到如下主从节点对应关系</p><table><thead><tr><th>主节点（master）</th><th>从节点（slave）</th></tr></thead><tbody><tr><td>192.168.3.39:8001</td><td>192.168.3.129:8005</td></tr><tr><td>192.168.3.129:8002</td><td>192.168.3.130:8006</td></tr><tr><td>192.168.3.130:8003</td><td>192.168.3.39:8004</td></tr></tbody></table></blockquote><h4 id="_3-操作集群数据" tabindex="-1"><a class="header-anchor" href="#_3-操作集群数据"><span>3. 操作集群数据</span></a></h4><blockquote><p>下列命令中由操作反馈可知<code>set a 1</code>的数据写入到了8003实例中，<code>set b 2</code>的数据写入到了8001实例中；</p><p>通过<code>keys *</code>命令也可以得到8001实例中只有<code>b</code>的值而没有<code>a</code>的值，这就是redis集群的分片存储；</p></blockquote><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>set</span><span class="space"> </span><span>a</span><span class="space"> </span><span>1</span></span>
<span class="line"><span>-&gt;</span><span class="space"> </span><span>Redirected</span><span class="space"> </span><span>to</span><span class="space"> </span><span>slot</span><span class="space"> </span><span>[15495]</span><span class="space"> </span><span>located</span><span class="space"> </span><span>at</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>192.168.3.130:8003&gt;</span><span class="space"> </span><span>get</span><span class="space"> </span><span>a</span></span>
<span class="line"><span>&quot;1&quot;</span></span>
<span class="line"><span>192.168.3.130:8003&gt;</span><span class="space"> </span><span>set</span><span class="space"> </span><span>b</span><span class="space"> </span><span>2</span></span>
<span class="line"><span>-&gt;</span><span class="space"> </span><span>Redirected</span><span class="space"> </span><span>to</span><span class="space"> </span><span>slot</span><span class="space"> </span><span>[3300]</span><span class="space"> </span><span>located</span><span class="space"> </span><span>at</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span>OK</span></span>
<span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>get</span><span class="space"> </span><span>b</span></span>
<span class="line"><span>&quot;2&quot;</span></span>
<span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>keys</span><span class="space"> </span><span>*</span></span>
<span class="line"><span>1)</span><span class="space"> </span><span>&quot;b&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-关闭集群" tabindex="-1"><a class="header-anchor" href="#_10-关闭集群"><span>10. 关闭集群</span></a></h3><p>逐个关闭实例</p><pre><code>src/redis-cli -a foobared -c -h 192.168.3.39 -p 8001 shutdown
src/redis-cli -a foobared -c -h 192.168.3.39 -p 8004 shutdown
src/redis-cli -a foobared -c -h 192.168.3.129 -p 8002 shutdown
src/redis-cli -a foobared -c -h 192.168.3.129 -p 8005 shutdown
src/redis-cli -a foobared -c -h 192.168.3.130 -p 8003 shutdown
src/redis-cli -a foobared -c -h 192.168.3.130 -p 8006 shutdown
...
</code></pre><blockquote><p>关闭后，再次启动只需执行各个实例的启动命令即可;</p><p>例：<code>src/redis-server redis-cluster-8001.conf</code>；</p></blockquote><h3 id="_11-使用spring-boot整合redis进行验证" tabindex="-1"><a class="header-anchor" href="#_11-使用spring-boot整合redis进行验证"><span>11. 使用Spring Boot整合redis进行验证</span></a></h3><h4 id="_1-加入依赖" tabindex="-1"><a class="header-anchor" href="#_1-加入依赖"><span>1. 加入依赖</span></a></h4><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">dependency</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">groupId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org.springframework.boot</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">groupId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">artifactId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">spring-boot-starter-data-redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">artifactId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">dependency</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-application-yml配置" tabindex="-1"><a class="header-anchor" href="#_2-application-yml配置"><span>2. application.yml配置</span></a></h4><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">spring</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">database</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3000</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">集群模式</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">nodes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.39:8001,192.168.3.39:8004,192.168.3.129:8002,192.168.3.129:8005,192.168.3.130:8003,192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">redis访问密码</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">foobared</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-编写测试代码" tabindex="-1"><a class="header-anchor" href="#_3-编写测试代码"><span>3. 编写测试代码</span></a></h4><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">lombok</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">extern</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slf4j</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Slf4j</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">springframework</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">beans</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">factory</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">annotation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Autowired</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">springframework</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">core</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">StringRedisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">springframework</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">annotation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">RequestMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">org</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">springframework</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">annotation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">RestController</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/**</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">*</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">@author</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">yunze</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">*</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">@date</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">2023/8/15</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">23:20</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">*/</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Slf4j</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RestController</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequestMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/demo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">class</span><span class="space"> </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">DemoController</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">Autowired</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">private</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">StringRedisTemplate</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">stringRedisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">RequestMapping</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/test_cluster</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">public</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">void</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">testCluster</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1000</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">while</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">try</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">stringRedisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">test-cluster-</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">valueOf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">info</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">设置key：{}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">test-</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Thread</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sleep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1000</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">String</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">val</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">stringRedisTemplate</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">opsForValue</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">().</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">test-cluster-</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">info</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">获取{}值:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">test-</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">i</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">val</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">catch</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Exception</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">printStackTrace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">出现异常：{}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">e</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getMessage</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="集群的水平扩展" tabindex="-1"><a class="header-anchor" href="#集群的水平扩展"><span>集群的水平扩展</span></a></h2><ol><li><p>增加节点信息如下</p><p>192.168.3.39：8007(master主节点)</p><p>192.168.3.129：8008(slave从节点)</p><p>192.168.3.130：8009(slave从节点)</p></li><li><p>根据最初”redis的集群搭建“里的1~4步操作准备好新增节点信息和配置</p></li><li><p>启动8007、8009实例</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8007.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8008.conf</span></span>
<span class="line"><span>src/redis-server</span><span class="space"> </span><span>redis-cluster-8009.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>将8007实例加入集群</p><blockquote><p>注意：需要保持8007节点里此时还没有数据，且还没有加入到其他集群，否则在加入的时候会失败，会提示如下信息（[ERR] Node 192.168.3.39:8007 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.）</p><p>解决方法：进入8007节点执行如下两条命令</p><p>192.168.3.39:8007&gt; flushall</p><p>192.168.3.39:8007&gt; cluster reset</p></blockquote><p>执行命令<code>src/redis-cli -a foobared --cluster add-node new_host:new_port existing_host:existing_port</code>；其中foobared 为访问密码，new_host:new_port为新实例地址，existing_host:existing_port为已经存在于集群的实例地址（任意一个节点都可以）；</p><p>如下所示：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>add-node</span><span class="space"> </span><span>192.168.3.39:8007</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span>Warning:</span><span class="space"> </span><span>Using</span><span class="space"> </span><span>a</span><span class="space"> </span><span>password</span><span class="space"> </span><span>with</span><span class="space"> </span><span>&#39;-a&#39;</span><span class="space"> </span><span>or</span><span class="space"> </span><span>&#39;-u&#39;</span><span class="space"> </span><span>option</span><span class="space"> </span><span>on</span><span class="space"> </span><span>the</span><span class="space"> </span><span>command</span><span class="space"> </span><span>line</span><span class="space"> </span><span>interface</span><span class="space"> </span><span>may</span><span class="space"> </span><span>not</span><span class="space"> </span><span>be</span><span class="space"> </span><span>safe.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Adding</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.39:8007</span><span class="space"> </span><span>to</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Performing</span><span class="space"> </span><span>Cluster</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>(using</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.39:8001)</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[0-5460]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[10923-16383]</span><span class="space"> </span><span>(5461</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[5461-10922]</span><span class="space"> </span><span>(5462</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>nodes</span><span class="space"> </span><span>agree</span><span class="space"> </span><span>about</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>configuration.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>for</span><span class="space"> </span><span>open</span><span class="space"> </span><span>slots...</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>coverage...</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>16384</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>covered.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Send</span><span class="space"> </span><span>CLUSTER</span><span class="space"> </span><span>MEET</span><span class="space"> </span><span>to</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.39:8007</span><span class="space"> </span><span>to</span><span class="space"> </span><span>make</span><span class="space"> </span><span>it</span><span class="space"> </span><span>join</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster.</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>New</span><span class="space"> </span><span>node</span><span class="space"> </span><span>added</span><span class="space"> </span><span>correctly.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此操作的用途为，让集群里的一个节点，发送meet给新加入的节点，邀请其加入集群；</p><blockquote><p>gossip协议包含多种消息，包括ping，pong，meet，fail等等</p><p><strong>gossip通信的10000端口</strong></p><p>每个节点实例都有一个专门用于节点间gossip通信的端口，就是自己提供服务的端口号+10000，比如8001，那么 用于节点间通信的就是18001端口。 每个节点每隔一段时间都会往另外几个节点发送ping消息，同时其他节点接收到ping消息之后返回pong消息。</p><p>meet：集群内的某个节点发送meet给新加入的节点，让新节点加入集群中，然后新节点就会开始与其他节点进行通信；</p><p>ping：每个节点都会频繁给其他节点发送ping，其中包含自己的状态还有自己维护的集群元数据，互相通过 ping交换元数据(类似自己感知到的集群节点增加和移除，hash slot信息等);</p><p>pong：对ping和meet消息的返回，包含自己的状态和其他信息，也可以用于信息广播和更新;</p><p>fail：对ping和meet消息的返回，包含自己的状态和其他信息，也可以用于信息广播和更新；</p></blockquote></li><li><p>查看节点信息</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8001</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>nodes</span></span>
<span class="line"><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004@18004</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238361500</span><span class="space"> </span><span>4</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003@18003</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238363508</span><span class="space"> </span><span>3</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>10923-16383</span></span>
<span class="line"><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006@18006</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238361000</span><span class="space"> </span><span>6</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005@18005</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238362503</span><span class="space"> </span><span>12</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001@18001</span><span class="space"> </span><span>myself,master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238363000</span><span class="space"> </span><span>12</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>0-5460</span></span>
<span class="line"><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002@18002</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238360000</span><span class="space"> </span><span>2</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>5461-10922</span></span>
<span class="line"><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>192.168.3.39:8007@18007</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693238360000</span><span class="space"> </span><span>0</span><span class="space"> </span><span>connected</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由返回信息可看出，此时8007节点已经加入了集群；</p><blockquote><p>注意：此时8007实例节点还是处于无法访问的状态，因为他还没有槽位；</p><p>此时的8001节点槽位为 0 ~ 5460 ，8002节点的槽位为 5461 ~ 10922 ，8003节点的槽位为 10923 ~ 16383 ；</p></blockquote></li></ol><blockquote><p>槽位：redis集群会将所有数据划分为 16384 个 slots(槽位)，每个小集群的主节点负责其中一部分槽位。槽位的信息存储于每 个节点中；当客户端来连接集群时，客户端它也会得到一份集群的槽位配置信息并将其缓存在客户端本地。这样当客户端要查找某个 key 时，可以直接定位到这个key在某个槽位，这个槽位又在哪个节点上；</p><p>槽位定位算法：<strong>HASH_SLOT = CRC16(key) mod 16384</strong>，</p><p>Cluster 默认会对 key 值使用 crc16 算法进行 hash 得到一个整数值，然后用这个整数值对 16384 进行取模 来得到具体槽位。</p></blockquote><ol start="6"><li><p>将其他机器的槽位迁移到8007节点，为其他机器分担数据</p><p>操作步骤如下所示：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">yunze@localhost</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">redis-5.0.14</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">src/redis-cli</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">-a</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">foobared</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cluster</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">reshard</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">192.168.3.39:8001</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Warning:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Using</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">password</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">with</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-a</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">or</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-u</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">option</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">on</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">command</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">line</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">interface</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">may</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">not</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">be</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">safe.</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;&gt;&gt;</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Performing</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Cluster</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Check</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(using</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.39:8001</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">M:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.39:8001</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:[0-5460]</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(5461</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">additional</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">replica</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">M:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.129:8002</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:[5461-10922]</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(5462</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">additional</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">replica</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">S:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">replicates</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">M:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.130:8003</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:[10923-16383]</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(5461</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">additional</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">replica</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">s</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">S:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.129:8005</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">replicates</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">M:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.39:8007</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">master</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">S:</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.3.39:8004</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">slots:</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">replicates</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">OK</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">All</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">nodes</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">agree</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">about</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slots</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">configuration.</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;&gt;&gt;</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Check</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">for</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">open</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots...</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt;&gt;&gt;</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Check</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">coverage...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">OK</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">All</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">16384</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">slots</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">covered.</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">How</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">many</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">do</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">you</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">want</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">to</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">move</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(from</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">to</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">16384</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">500</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">What</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">is</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">receiving</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ID?</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3e10e499ae56381a78f402d5587a1d86b495b3d1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Please</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">enter</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">all</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">IDs.</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Type</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">all</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">to</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">use</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">all</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nodes</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">as</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nodes</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">for</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hash</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slots.</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Type</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">done</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">once</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">you</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">entered</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">all</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">nodes</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">IDs.</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Source</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#1:</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">all</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Moving</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slot</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">11081</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">from</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Moving</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slot</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">11082</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">from</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Moving</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slot</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">11083</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">from</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Moving</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">slot</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">11088</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">from</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Do</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">you</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">want</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">to</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">proceed</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">with</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">the</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">proposed</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">reshard</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">plan</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">(yes/no)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>How many slots do you want to move (from 1 to 16384)? 500</p><p>（ps:需要将8001节点的多少个槽位迁移到新的节点上，此处设置的500个）</p><p>What is the receiving node ID? 3e10e499ae56381a78f402d5587a1d86b495b3d1</p><p>（ps:需要将这500个槽位迁移到哪个节点上，此处设置的3e10e499ae56381a78f402d5587a1d86b495b3d1为8007实例节点的标识）</p><p>Do you want to proceed with the proposed reshard plan (yes/no)? yes</p><p>（ps:是否确认开始执行分片计划）</p></li><li><p>查看集群最新节点信息</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8001</span></span>
<span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>nodes</span></span>
<span class="line"><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002@18002</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400355000</span><span class="space"> </span><span>17</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>5628-10922</span></span>
<span class="line"><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006@18006</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400357857</span><span class="space"> </span><span>17</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003@18003</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400352000</span><span class="space"> </span><span>16</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>11089-16383</span></span>
<span class="line"><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001@18001</span><span class="space"> </span><span>myself,master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400354000</span><span class="space"> </span><span>14</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>166-5460</span></span>
<span class="line"><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005@18005</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400353000</span><span class="space"> </span><span>14</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>192.168.3.39:8007@18007</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400356846</span><span class="space"> </span><span>18</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>0-165</span><span class="space"> </span><span>5461-5627</span><span class="space"> </span><span>10923-11088</span></span>
<span class="line"><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004@18004</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693400355837</span><span class="space"> </span><span>16</span><span class="space"> </span><span>connected</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到8007实例节点的槽位为0-165、5461-5627、10923-11088</p><p>进入到8007实例节点也可以看到很多数据也随着槽位迁移了过来</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8007</span></span>
<span class="line"><span>192.168.3.39:8007&gt;</span><span class="space"> </span><span>keys</span><span class="space"> </span><span>*</span></span>
<span class="line"><span class="space"> </span><span>1)</span><span class="space"> </span><span>&quot;test-cluster-688&quot;</span></span>
<span class="line"><span class="space"> </span><span>2)</span><span class="space"> </span><span>&quot;test-cluster-311&quot;</span></span>
<span class="line"><span class="space"> </span><span>...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此集群的节点扩展成功！</p></li><li><p>将8008、8009实例加入到集群，并设置为8007实例的从节点</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>add-node</span><span class="space"> </span><span>192.168.3.129:8008</span><span class="space"> </span><span>192.168.3.39:8007</span><span class="space"> </span><span>--cluster-slave</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Adding</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.129:8008</span><span class="space"> </span><span>to</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>192.168.3.39:8007</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Performing</span><span class="space"> </span><span>Cluster</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>(using</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.39:8007)</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>192.168.3.39:8007</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[0-165],[5461-5627],[10923-11088]</span><span class="space"> </span><span>(499</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[166-5460]</span><span class="space"> </span><span>(5295</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[11089-16383]</span><span class="space"> </span><span>(5295</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>M:</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:[5628-10922]</span><span class="space"> </span><span>(5295</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>master</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>1</span><span class="space"> </span><span>additional</span><span class="space"> </span><span>replica(s)</span></span>
<span class="line"><span>S:</span><span class="space"> </span><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>slots:</span><span class="space"> </span><span>(0</span><span class="space"> </span><span>slots)</span><span class="space"> </span><span>slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>replicates</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>nodes</span><span class="space"> </span><span>agree</span><span class="space"> </span><span>about</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>configuration.</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>for</span><span class="space"> </span><span>open</span><span class="space"> </span><span>slots...</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Check</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>coverage...</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>All</span><span class="space"> </span><span>16384</span><span class="space"> </span><span>slots</span><span class="space"> </span><span>covered.</span></span>
<span class="line"><span>Automatically</span><span class="space"> </span><span>selected</span><span class="space"> </span><span>master</span><span class="space"> </span><span>192.168.3.39:8007</span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Send</span><span class="space"> </span><span>CLUSTER</span><span class="space"> </span><span>MEET</span><span class="space"> </span><span>to</span><span class="space"> </span><span>node</span><span class="space"> </span><span>192.168.3.129:8008</span><span class="space"> </span><span>to</span><span class="space"> </span><span>make</span><span class="space"> </span><span>it</span><span class="space"> </span><span>join</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster.</span></span>
<span class="line"><span>Waiting</span><span class="space"> </span><span>for</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>to</span><span class="space"> </span><span>join</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&gt;&gt;&gt;</span><span class="space"> </span><span>Configure</span><span class="space"> </span><span>node</span><span class="space"> </span><span>as</span><span class="space"> </span><span>replica</span><span class="space"> </span><span>of</span><span class="space"> </span><span>192.168.3.39:8007.</span></span>
<span class="line"><span>[OK]</span><span class="space"> </span><span>New</span><span class="space"> </span><span>node</span><span class="space"> </span><span>added</span><span class="space"> </span><span>correctly.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>8009同样操作</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>add-node</span><span class="space"> </span><span>192.168.3.130:8009</span><span class="space"> </span><span>192.168.3.39:8007</span><span class="space"> </span><span>--cluster-slave</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>查看最新节点信息</p><p>从返回信息里可以看到8008和8009成为了8007节点的slave从节点</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8007</span></span>
<span class="line"><span>192.168.3.39:8007&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>nodes</span></span>
<span class="line"><span>3324378c7a09aa263564fbda842b7e502006a7c9</span><span class="space"> </span><span>192.168.3.130:8006@18006</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401841631</span><span class="space"> </span><span>17</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>0a8c08e30cfa7e7d74b87e2a80d9785da6859e41</span><span class="space"> </span><span>192.168.3.129:8002@18002</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401845000</span><span class="space"> </span><span>17</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>5628-10922</span></span>
<span class="line"><span>1c9571a96ac7ebb387daedd5617f50c95d1deccd</span><span class="space"> </span><span>192.168.3.130:8009@18009</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401843000</span><span class="space"> </span><span>18</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>192.168.3.39:8001@18001</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401842000</span><span class="space"> </span><span>14</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>166-5460</span></span>
<span class="line"><span>e933c3c4573dd2a20420f5d0240e5a22acbf5869</span><span class="space"> </span><span>192.168.3.129:8008@18008</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401845671</span><span class="space"> </span><span>18</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>267be1f6daa96c102e683ab077ab4618df4e70e7</span><span class="space"> </span><span>192.168.3.129:8005@18005</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>3848be4f9e9b4f9e1887dcdbe0f5b641f2b05103</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401844000</span><span class="space"> </span><span>14</span><span class="space"> </span><span>connected</span></span>
<span class="line"><span>3e10e499ae56381a78f402d5587a1d86b495b3d1</span><span class="space"> </span><span>192.168.3.39:8007@18007</span><span class="space"> </span><span>myself,master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401842000</span><span class="space"> </span><span>18</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>0-165</span><span class="space"> </span><span>5461-5627</span><span class="space"> </span><span>10923-11088</span></span>
<span class="line"><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>192.168.3.130:8003@18003</span><span class="space"> </span><span>master</span><span class="space"> </span><span>-</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401844000</span><span class="space"> </span><span>16</span><span class="space"> </span><span>connected</span><span class="space"> </span><span>11089-16383</span></span>
<span class="line"><span>4b53f3e178f13b75edb65e5ec31c58985d54a4c1</span><span class="space"> </span><span>192.168.3.39:8004@18004</span><span class="space"> </span><span>slave</span><span class="space"> </span><span>68b19c491aa909350896a0ce4be75c5ed8cb8dde</span><span class="space"> </span><span>0</span><span class="space"> </span><span>1693401844656</span><span class="space"> </span><span>16</span><span class="space"> </span><span>connected</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="9"><li><p>redis集群移除节点</p><p>执行如下命令：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>&lt;password&gt;</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>&lt;node-ip&gt;</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>&lt;node-port&gt;</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>forget</span><span class="space"> </span><span>&lt;node-id&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>password：集群访问密码</p><p>node-ip：集群任一节点的ip地址</p><p>node-port：集群一节点的端口</p><p>node-id：需要移除的节点标识符</p></li><li><p>redis集群解散</p><p>先清理各节点的数据</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8001</span></span>
<span class="line"><span>192.168.3.39:8001&gt;</span><span class="space"> </span><span>flushall</span></span>
<span class="line"><span></span></span>
<span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.129</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8002</span></span>
<span class="line"><span>192.168.3.129:8002&gt;</span><span class="space"> </span><span>flushall</span></span>
<span class="line"><span></span></span>
<span class="line"><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.130</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8003</span></span>
<span class="line"><span>192.168.3.130:8003&gt;</span><span class="space"> </span><span>flushall</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>-a</span><span class="space"> </span><span>foobared</span><span class="space"> </span><span>-c</span><span class="space"> </span><span>-h</span><span class="space"> </span><span>192.168.3.39</span><span class="space"> </span><span>-p</span><span class="space"> </span><span>8001</span><span class="space"> </span><span>cluster</span><span class="space"> </span><span>reset</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>查看redis集群的命令帮助</p></li></ol><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>[yunze@localhost</span><span class="space"> </span><span>redis-5.0.14]$</span><span class="space"> </span><span>src/redis-cli</span><span class="space"> </span><span>--cluster</span><span class="space"> </span><span>help</span></span>
<span class="line"><span>Cluster</span><span class="space"> </span><span>Manager</span><span class="space"> </span><span>Commands:</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>create</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host1:port1</span><span class="space"> </span><span>...</span><span class="space"> </span><span>hostN:portN</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-replicas</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>check</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-search-multiple-owners</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>info</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>fix</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-search-multiple-owners</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>reshard</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-from</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-to</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-slots</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-yes</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-timeout</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-pipeline</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-replace</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>rebalance</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-weight</span><span class="space"> </span><span>&lt;node1=w1...nodeN=wN&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-use-empty-masters</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-timeout</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-simulate</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-pipeline</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-threshold</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-replace</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>add-node</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>new_host:new_port</span><span class="space"> </span><span>existing_host:existing_port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-slave</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-master-id</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>del-node</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span><span class="space"> </span><span>node_id</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>call</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span><span class="space"> </span><span>command</span><span class="space"> </span><span>arg</span><span class="space"> </span><span>arg</span><span class="space"> </span><span>..</span><span class="space"> </span><span>arg</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>set-timeout</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span><span class="space"> </span><span>milliseconds</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>import</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>host:port</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-from</span><span class="space"> </span><span>&lt;arg&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-copy</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>--cluster-replace</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>help</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span></span></span>
<span class="line"><span>For</span><span class="space"> </span><span>check,</span><span class="space"> </span><span>fix,</span><span class="space"> </span><span>reshard,</span><span class="space"> </span><span>del-node,</span><span class="space"> </span><span>set-timeout</span><span class="space"> </span><span>you</span><span class="space"> </span><span>can</span><span class="space"> </span><span>specify</span><span class="space"> </span><span>the</span><span class="space"> </span><span>host</span><span class="space"> </span><span>and</span><span class="space"> </span><span>port</span><span class="space"> </span><span>of</span><span class="space"> </span><span>any</span><span class="space"> </span><span>working</span><span class="space"> </span><span>node</span><span class="space"> </span><span>in</span><span class="space"> </span><span>the</span><span class="space"> </span><span>cluster.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="faq" tabindex="-1"><a class="header-anchor" href="#faq"><span>FAQ</span></a></h2><h3 id="redis集群对批量操作命令的支持" tabindex="-1"><a class="header-anchor" href="#redis集群对批量操作命令的支持"><span>Redis集群对批量操作命令的支持</span></a></h3><p>对于类似mset，mget这样的多个key的原生批量操作命令，redis集群只支持所有key落在同一slot的情况，如果有多个key一定要用mset命令在redis集群上操作，则可以在key的前面加上{XX}，这样参数数据分片hash计 算的只会是大括号里的值，这样能确保不同的key能落到同一slot里去，示例如下：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>192.168.3.39:8007&gt;</span><span class="space"> </span><span>mset</span><span class="space"> </span><span>{user}:1:name</span><span class="space"> </span><span>lisi</span><span class="space"> </span><span>{user}:1:sex</span><span class="space"> </span><span>1</span><span class="space"> </span><span>{user}:1:age</span><span class="space"> </span><span>18</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>假设name和age计算的hash slot值不一样，但是这条命令在集群下执行，redis只会用大括号里的 user1做hash slot计算，所以算出来的slot值肯定相同，最后都能落在同一slot。</p><h3 id="集群的选举原理分析" tabindex="-1"><a class="header-anchor" href="#集群的选举原理分析"><span>集群的选举原理分析</span></a></h3><p>关闭集群的节点8007实例（8007实例为master主节点、8008、8009实例为slave从节点）时，8007实例节点在集群中的状态会变为fail。当8008、8009的slave实例节点发现自己的master主节点变成了fail，便会尝试failover机制。</p><blockquote><p>failover是redis cluster提供的容错机制，cluster最核心的功能之一。failover表现在一个master分片故障后，slave接管master的过程。</p><p>其支持两种模式：</p><ol><li><p>故障failover：自动恢复集群的可用性；</p></li><li><p>人为failover：支持集群的可运维操作；</p></li></ol></blockquote><p>过程如下：</p><ol><li>slave发现自己的master节点变为fail；</li><li>slave将自己记录的集群周期加1，及currentEpoch加1，并广播FAILOVER_AUTH_REQUEST信息；</li><li>集群其他所有节点都会收到该信息，但是只有master主节点会进行响应，会判断请求者的合法性（发送请求的节点是否是8007主节点的slave从节点），并发送FILOVER_AUTH_ACK，每个master主节点对每一个epoch周期只发送一次ack；（例：8001实例接收到了8008和8009两个slave节点的FAILOVER_AUTH_REQUEST信息（假设8001先接收到8008节点的请求），但是8001这个master节点只会响应先接收的那个请求，即响应8008节点，对其发送FILOVER_AUTH_ACK信息；</li><li>尝试failover的8008和8009 slave节点会收集各master节点返回的FILOVER_AUTH_ACK；</li><li>如果某一slave收到了超过半数master节点的ack，就会变成该小集群里新的master节点；（集群至少要有3个主节点的原因）（如果8008和8009 <strong>两个slave节点收到的都是刚好半数的master节点的ack，则会重新从第2步开始</strong> ）</li><li>该slave会广播pong消息通知其他集群节点终止选举；</li></ol><p>从节点并不是在主节点一进入 FAIL 状态就马上尝试发起选举，而是有一定延迟，一定的延迟确保我们等待 FAIL状态在集群中传播，slave如果立即尝试选举，其它masters或许尚未意识到FAIL状态，可能会拒绝投票。</p><blockquote><p>延迟计算公式：</p><p>DELAY = 500ms + random(0 ~ 500ms) + SLAVE_RANK * 1000ms</p><p>其中SLAVE_RANK表示此slave已经从master复制数据的总量的rank。Rank越小代表已复制的数据越新。这种方式下，理论上持有最新数据的slave将会首先发起选举，也是最有机会被选为新的主节点。</p></blockquote><h3 id="集群脑裂数据丢失问题" tabindex="-1"><a class="header-anchor" href="#集群脑裂数据丢失问题"><span>集群脑裂数据丢失问题</span></a></h3><p>网络分区（一个小集群的master节点与其slave节点和整个大集群各节点网络不通了）导致脑裂后多个主节点对外提供写服务（一个小集群里有多个master主节点），一旦网络分区恢复， 会将其中一个主节点变为从节点，这时会有大量数据丢失。</p><p>规避方法可以在redis配置里加上参数（这种方法不可能百分百避免数据丢失，参考集群leader选举机制）：</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">写数据成功最少同步的slave数量，这个数量可以模仿大于半数机制配置，比如</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">集群总共三个节点可以配置1，加上leader就是2，超过了半数</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">min‐replicas‐to‐write</span><span class="space"> </span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：这个配置在一定程度上会影响集群的可用性，比如slave要是少于1个，这个集群就算leader正常也不能提供服务了，需要具体场景权衡选择</p></blockquote>`,83)]))}const d=a(c,[["render",l],["__file","index.html.vue"]]),h=JSON.parse('{"path":"/article/av5qj8as/","title":"Redis的集群搭建配置","lang":"zh-CN","frontmatter":{"title":"Redis的集群搭建配置","createTime":"2022/01/05 13:55:59","permalink":"/article/av5qj8as/","tags":["手册","redis","集群架构"],"description":"Redis集群的架构是通过哈希槽算法实现数据分片存储，以及主从结构解决读写分离和负载均衡问题。集群节点间的通信机制为gossip协议，负责处理集群的故障检测与恢复流程，以及集群的扩容、收缩操作。 Redis的集群搭建配置 此案例在3台虚拟机上每台机搭建一个master主节点和一个slave从节点，共3个master节点，3个slave从节点，共计6个r...","head":[["meta",{"property":"og:url","content":"https://blog.gaohan.asia/article/av5qj8as/"}],["meta",{"property":"og:site_name","content":"云泽汇码"}],["meta",{"property":"og:title","content":"Redis的集群搭建配置"}],["meta",{"property":"og:description","content":"Redis集群的架构是通过哈希槽算法实现数据分片存储，以及主从结构解决读写分离和负载均衡问题。集群节点间的通信机制为gossip协议，负责处理集群的故障检测与恢复流程，以及集群的扩容、收缩操作。 Redis的集群搭建配置 此案例在3台虚拟机上每台机搭建一个master主节点和一个slave从节点，共3个master节点，3个slave从节点，共计6个r..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-06T01:26:28.000Z"}],["meta",{"property":"article:tag","content":"手册"}],["meta",{"property":"article:tag","content":"redis"}],["meta",{"property":"article:tag","content":"集群架构"}],["meta",{"property":"article:modified_time","content":"2025-09-06T01:26:28.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis的集群搭建配置\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-09-06T01:26:28.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":17.46,"words":5237},"git":{"updatedTime":1757121988000,"contributors":[{"name":"yunze","username":"yunze","email":"56632502+YUNZE-GH@users.noreply.github.com","commits":9,"avatar":"https://avatars.githubusercontent.com/yunze?v=4","url":"https://github.com/yunze"},{"name":"yunze","username":"yunze","email":"834363368@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/yunze?v=4","url":"https://github.com/yunze"}]},"autoDesc":true,"filePathRelative":"database/124.Redis的集群搭建配置.md","categoryList":[{"id":"11e0ee","sort":10005,"name":"database"}]}');export{d as comp,h as data};
