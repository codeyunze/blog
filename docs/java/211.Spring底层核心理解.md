# Spring底层核心理解

## Spring的核心主要功能

 1. 统一管理Bean对象，并在需要的时候自动注入，这就是IOC容器；

 2. 在调用Bean对象执行方法时，对业务方法进行非业务功能扩展（例如日志记录等），则是AOP切面。

    Bean的概念：Bean是对象，但对象不一定是Bean，普通对象通过new Object创建，Bean则由Spring帮忙创建；

    创建Bean的基础代码：

    main()

    ```java
    AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
    UserService userService = (UserService) context.getBean("userService");
    userService.test();
    ```

    UserService.class

    ```java
     @Autowrite
     public User admin; // 管理员信息
    
     public userService(){
    
     }
    
     public void test(){
    
     }
    
    // 查询管理员用户信息
     @PostConsttruct
     public void queryUserAdminInfo() {
    
     }
    ```

    

## Bean的创建流程（Bean的创建生命周期）

>  UserService.class--->构造方法--->创建普通对象--->依赖注入（属性赋值）--->初始化前--->初始化--->初始化后（AOP）--->CGLIB代理对象--->Bean

 1. 创建普通构造方法：通过调用构造方法，创建一个UserService的普通对象；

 2. 依赖注入（属性赋值）：使用构造方法创建UserService对象之后，该对象里的属性此时是没有值的，如果需要给UserService对象里的属性赋值，则需要给属性加上@Autowrite注解，Spring会遍历该对象里的所有属性，找出带有@Autowrite注解的属性，然后赋值；
    在main()方法里，userService.test()执行完之后执行

    ```java
    for(Field field : userService.getClass().getFields()) {
        // 判断属性是否有Autowrite注解
       if(field.isAnnotationPresent(Autowrite.class)) {
           // 有加注解，则赋值
           field.set(userService, ???)
       }
    }
    ```

 3. 初始化前：依赖注入之后，UserService对象里的属性有值了，但也只是new出来的初始值，和我们想要的业务相关数据值还有点差距，需要调用方法去查询数据库，然后给属性赋值，但是Spring怎么知道要调这个方法去给属性赋值呢？可以给方法加@PostConstruct注解，Spring会遍历该对象里的所有属性，找出带有@PostConstruct注解的方法，然后执行该方法；
    在main()方法里，userService.test()执行完之后执行

 ```java
 for(Method method : userService.getClass().getMethods()) {
    // 判断方法是否有PostConstruct注解
   if(field.isAnnotationPresent(PostConstruct.class)) {
       // 有加注解，则执行
       method.invoke(userService, null);
   }
}
 ```

  4. 初始化：初始化前里给属性赋值的操作在这里也可以实现，实现方法是UserService实现InitializingBean接口，Spring会判断UserService对象有没有实现该接口，如果实现了则会调用InitializingBean接口的afterPropertiesSet()方法；UserService对象可以重写父类InitializingBean的afterPropertiesSet()方法，在afterPropertiesSet方法里进行数据查询操作；
     判断对象是否有实现某一接口

 ```java
if(userService of InitializingBean) {
    // 表示userService实现了InitializingBean接口
   (InitializingBean)userService.afterPropertiesSet(); // 强转为InitializingBean对象，然后调用afterPropertiesSet方法
}
 ```

 此时也会判断是否有加AOP相关注解，是否需要加AOP切面扩展功能,

  如果不要，则当初始化结束后，此时的对象就是Bean；

  如果需要，则还需要进行生成代理对象后，才是Bean；

 

